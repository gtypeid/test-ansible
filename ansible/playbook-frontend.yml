---
- name: Frontend ì„œë²„ êµ¬ì„± (Nginx)
  hosts: frontend
  become: yes

  tasks:
    - name: ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
      apt:
        update_cache: yes

    - name: Nginx ì„¤ì¹˜
      apt:
        name: nginx
        state: present

    - name: ì›¹ ë£¨íŠ¸ ë””ë ‰í† ë¦¬ ìƒì„±
      file:
        path: "{{ web_root }}"
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    # ğŸ”¥ synchronize ëŒ€ì‹  copy ì‚¬ìš©
    - name: Frontend íŒŒì¼ ë³µì‚¬
      copy:
        src: ../frontend/
        dest: "{{ web_root }}/"
        owner: www-data
        group: www-data
        mode: '0644'
      notify: reload nginx

    - name: íŒŒì¼ ê¶Œí•œ ì„¤ì •
      file:
        path: "{{ web_root }}"
        owner: www-data
        group: www-data
        recurse: yes

    - name: Nginx ì„¤ì • íŒŒì¼ ìƒì„± (sites-available)
      copy:
        content: |
          server {
              listen 80;
              server_name {{ hostvars['web1']['ansible_host'] }};
          
              root {{ web_root }};
              index index.html;
          
              location / {
                  try_files $uri $uri/ /index.html;
              }
          
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
                  expires 1y;
                  add_header Cache-Control "public, immutable";
              }
          
              location /api/ {
                  proxy_pass http://{{ api_host }}:{{ api_port }}/;
                  proxy_set_header Host $host;
                  proxy_set_header X-Real-IP $remote_addr;
                  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto $scheme;
          
                  add_header 'Access-Control-Allow-Origin' '*';
                  add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
                  add_header 'Access-Control-Allow-Headers' 'Content-Type, Authorization';
          
                  if ($request_method = 'OPTIONS') {
                      return 204;
                  }
              }
          
              access_log /var/log/nginx/frontend-access.log;
              error_log /var/log/nginx/frontend-error.log;
          }
        dest: "/etc/nginx/sites-available/{{ site_name }}"
        mode: '0644'
      notify: reload nginx

    - name: ê¸°ë³¸ ì‚¬ì´íŠ¸ ë¹„í™œì„±í™”
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      notify: reload nginx

    - name: Frontend ì‚¬ì´íŠ¸ í™œì„±í™”
      file:
        src: "/etc/nginx/sites-available/{{ site_name }}"
        dest: "/etc/nginx/sites-enabled/{{ site_name }}"
        state: link
      notify: reload nginx

    - name: Nginx ì„¤ì • ë¬¸ë²• í…ŒìŠ¤íŠ¸
      command: nginx -t
      register: nginx_test
      changed_when: false
      failed_when: nginx_test.rc != 0

    - name: ë°©í™”ë²½ HTTP í¬íŠ¸ ì—´ê¸°
      ufw:
        rule: allow
        port: 80
        proto: tcp

    - name: Nginx ì‹œì‘ ë° í™œì„±í™”
      service:
        name: nginx
        state: started
        enabled: yes

  handlers:
    - name: reload nginx
      service:
        name: nginx
        state: reloaded
